<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HP M1132 Controller</title>
    <style>
        :root { --bg: #1a1a1a; --card: #2d2d2d; --text: #e0e0e0; --accent: #007bff; --danger: #dc3545; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { max-width: 800px; width: 100%; display: grid; gap: 20px; }
        .card { background: var(--card); padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        h2 { margin-top: 0; border-bottom: 1px solid #444; padding-bottom: 10px; }
        
        /* Bot√µes e Inputs */
        button { background: var(--accent); color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-size: 16px; transition: opacity 0.2s; }
        button:disabled { opacity: 0.6; cursor: not-allowed; }
        input[type="file"] { margin-bottom: 10px; display: block; width: 100%; }
        
        /* √Årea do Scanner */
        .preview-area { min-height: 300px; background: #000; display: flex; align-items: center; justify-content: center; border: 2px dashed #444; margin-top: 15px; position: relative; }
        .preview-area img { max-width: 100%; max-height: 600px; display: none; }
        .preview-area.has-image img { display: block; }
        .preview-area.has-image::after { content: ''; display: none; }
        
        /* Spinner */
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--accent); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; position: absolute; display: none; }
        .loading .loader { display: block; }
        
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .status { margin-top: 10px; font-size: 0.9em; color: #aaa; }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <h2>üñ®Ô∏è Imprimir Arquivo</h2>
        <form id="printForm">
            <input type="file" id="fileInput" accept=".pdf,.jpg,.png,.txt" required>
            <button type="submit" id="btn-print">Enviar para Impressora</button>
        </form>
        <div id="printStatus" class="status"></div>
    </div>

    <div class="card">
        <h2>üìÑ Scanner</h2>
        <div style="display: flex; gap: 10px;">
            <button id="btn-scan" onclick="startScan()">Digitalizar Agora</button>
            <a id="btn-download" href="#" download="scan.jpg" style="display:none;"><button style="background:#28a745">Baixar Imagem</button></a>
        </div>
        
        <div id="scan-container" class="preview-area">
            <div class="loader"></div>
            <img id="scanPreview" src="" alt="Scan">
            <span id="placeholder-text" style="color:#666">Nenhuma imagem digitalizada</span>
        </div>
        <div id="scanStatus" class="status"></div>
    </div>
</div>

<script>
    // L√≥gica de Impress√£o (Upload)
    document.getElementById('printForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const fileInput = document.getElementById('fileInput');
        const btn = document.getElementById('btn-print');
        const status = document.getElementById('printStatus');

        if (!fileInput.files[0]) return;

        const formData = new FormData();
        formData.append('file', fileInput.files[0]);

        btn.disabled = true;
        btn.innerText = "Enviando...";
        status.innerText = "Enviando arquivo para o servidor...";

        try {
            const res = await fetch('/print', { method: 'POST', body: formData });
            const text = await res.text();
            if (res.ok) {
                status.innerText = "‚úÖ Sucesso: " + text;
                fileInput.value = ''; // Limpar input
            } else {
                throw new Error(text);
            }
        } catch (err) {
            status.innerText = "‚ùå Erro: " + err.message;
        } finally {
            btn.disabled = false;
            btn.innerText = "Enviar para Impressora";
        }
    });

    // L√≥gica do Scanner
    async function startScan() {
        const btn = document.getElementById('btn-scan');
        const container = document.getElementById('scan-container');
        const img = document.getElementById('scanPreview');
        const status = document.getElementById('scanStatus');
        const placeholder = document.getElementById('placeholder-text');
        const downloadBtn = document.getElementById('btn-download');

        btn.disabled = true;
        container.classList.add('loading');
        status.innerText = "‚è≥ O scanner est√° aquecendo e digitalizando... (aguarde ~20s)";
        
        try {
            // Chama o backend Go
            const res = await fetch('/scan');
            if (!res.ok) throw new Error(await res.text());

            // Sucesso
            const timestamp = new Date().getTime();
            const imgUrl = `/static/scan.jpg?t=${timestamp}`;
            
            img.onload = () => {
                container.classList.remove('loading');
                container.classList.add('has-image');
                placeholder.style.display = 'none';
                status.innerText = "‚úÖ Digitaliza√ß√£o conclu√≠da.";
                downloadBtn.href = imgUrl;
                downloadBtn.style.display = 'inline-block';
                btn.disabled = false;
            };
            
            img.onerror = () => {
                throw new Error("Imagem gerada inv√°lida ou corrompida.");
            }

            img.src = imgUrl; // For√ßa recarregamento da imagem

        } catch (err) {
            container.classList.remove('loading');
            status.innerText = "‚ùå Falha: " + err.message;
            btn.disabled = false;
        }
    }
</script>

</body>
</html>
